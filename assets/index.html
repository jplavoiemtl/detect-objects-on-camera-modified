<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Object Detection Arduino Q</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
    <!-- Top controls: Detection settings -->
    <div id="controls-top">
        <label for="confidenceSlider">Detection confidence</label>
        <div class="slider-row">
            <input type="range" id="confidenceSlider" min="0" max="1" step="0.05" value="0.6">
            <span id="confidenceValue">0.60</span>
            <select id="labelSelect" aria-label="Detection label" disabled>
                <option value="">No labels yet</option>
            </select>
        </div>
    </div>
    
    <!-- Bottom controls: Navigation and detection info -->
    <div id="controls-bottom">
        <div class="nav-row">
            <button id="btnOldest" class="nav-btn" title="Oldest detection" disabled>&laquo; Oldest</button>
            <button id="btnBack" class="nav-btn" title="Previous detection" disabled>&larr; Back</button>
            <button id="btnLive" class="nav-btn active" title="Live view">Live</button>
            <button id="btnForward" class="nav-btn" title="Next detection" disabled>Forward &rarr;</button>
            <button id="btnLatest" class="nav-btn" title="Latest detection">Latest &raquo;</button>
            <span id="positionIndicator" class="position-indicator">Live</span>
        </div>
        <div id="detectionInfo" class="detection-info" style="display: none;">
            <span class="info-label" id="infoLabel">-</span>
            <span class="info-confidence" id="infoConfidence">-</span>
            <span class="info-time" id="infoTime">-</span>
        </div>
        <div id="liveDateTime" class="live-datetime" aria-live="polite">-- -- ----, --:--</div>
    </div>
    <div id="video-container">
        <div id="videoFeedContainer">
            <div id="videoPlaceholder" class="camera-status">
                <img src="./img/no-face.svg" alt="Searching webcam">
                <p class="feedback-text">Searching Webcam...</p>
            </div>
            <!-- Wrapper clips the iframe to show only the video -->
            <div id="iframe-wrapper">
                <iframe id="dynamicIframe" title="Video stream"></iframe>
            </div>
            <!-- Saved detection image (shown when browsing history) -->
            <div id="saved-image-wrapper" style="display: none;">
                <img id="savedImage" alt="Saved detection" />
            </div>
        </div>
    </div>
    <div id="error-container" class="error-message" style="display: none;"></div>
    
    <script>
        // Video stream loading (scoped to avoid conflicts with app.js)
        (function() {
            const videoIframe = document.getElementById('dynamicIframe');
            const videoWrapper = document.getElementById('iframe-wrapper');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const currentHostname = window.location.hostname;
            const targetPort = 4912;
            const targetPath = '/embed';
            const streamUrl = `http://${currentHostname}:${targetPort}${targetPath}`;

            let retryTimeout = null;
            let loaded = false;

            videoIframe.onload = () => {
                if (retryTimeout) {
                    clearTimeout(retryTimeout);
                    retryTimeout = null;
                }
                loaded = true;
                videoPlaceholder.style.display = 'none';
                videoWrapper.style.display = 'block';
            };

            function attemptLoad() {
                if (loaded) return;
                videoIframe.src = streamUrl;
                // Give it 5 seconds to load before retrying
                retryTimeout = setTimeout(attemptLoad, 5000);
            }

            // Start loading immediately
            attemptLoad();
        })();
    </script>
    <script src="libs/socket.io.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
